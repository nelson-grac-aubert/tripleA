<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="template.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta http-equiv="refresh" content="30" />
    <title>TripleA</title>
</head>
<body>
    <header>
        <h1>Dashboard</h1>
    </header>
    <main>
        <!-- Système -->
        <section id="system">
            <h2>Système</h2>
            <div class="card">
                <p><strong>Nom de la machine :</strong> {{ machine_name }}</p>
                <p><strong>Système d'exploitation :</strong> {{ os_version }}</p>
                <p><strong>Heure d'allumage :</strong> {{ start_time }}</p>
                <p><strong>Uptime :</strong> {{ up_time }}</p>
                <p><strong>Nombre d'utilisateurs :</strong> {{ user_count }}</p>
            </div>
        </section>

        <!-- Réseau -->
        <section id="network">
            <h2>Réseau</h2>
            <div class="card">
                <p><strong>Adresse principale :</strong> {{ ip_address }}</p>
            </div>
        </section>

        <!-- CPU -->
        <section id="cpu">
            <h2>CPU</h2>
            <div class="card">
                <p><strong>Nombre de cœurs :</strong> {{ cpu_hearts }}</p>
                <p><strong>Fréquence :</strong> {{ cpu_frequency }} MHz</p>
                {% if cpu_usage_percent >=81 %}
                    <p class="red"><strong>Utilisation :</strong> {{ cpu_usage_percent }} %</p>
                {% elif cpu_usage_percent is gt(50) and cpu_usage_percent is lt(80) %}
                    <p class="orange"><strong>Utilisation :</strong> {{ cpu_usage_percent }} %</p>
                {% else %}
                    <p class="green"><strong>Utilisation :</strong> {{ cpu_usage_percent }} %</p>
                {% endif %}
            </div>
            <div class="card">
                <h3>Charge système moyenne</h3>
                {% for item in loads %}
                    {% if item.value | round(2) >=80 %}
                        <p class="red"><strong>{{ item.label }} :</strong> {{ item.value | round(2) }} %</p>
                    {% elif item.value is gt(50) and item.value is lt(80) %} 
                        <p class="orange"><strong>{{ item.label }} :</strong> {{ item.value | round(2) }} %</p>
                    {% elif  item.value is lt(50)%}
                        <p class="green"><strong>{{ item.label }} :</strong> {{ item.value | round(2) }} %</p>
                    {% endif %}
                {% endfor %}
            </div>
        </section>

        <!-- Mémoire & Stockage -->
        <section id="memory">
            <h2>Mémoire & Stockage</h2>
            <div class="card">
                <p><strong>RAM totale :</strong> {{ total_ram_gb | round(2) }} GB</p>
                <p><strong>RAM utilisée :</strong> {{ used_ram_gb | round(2) }} GB</p>
                {% if used_ram_percent >=81 %}
                    <p class="red"><strong>Utilisation RAM  :</strong> {{ used_ram_percent | round(1) }} %</p>
                {% elif used_ram_percent is gt(50) and used_ram_percent is lt(80) %}
                    <p class="orange"><strong>Utilisation RAM  :</strong> {{ used_ram_percent | round(1) }} %</p>
                {% else %}
                    <p class="green"><strong>Utilisation RAM  :</strong> {{ used_ram_percent | round(1) }} %</p>
                {% endif %}
            </div>
            <div class="card">
                <p><strong>Stockage total :</strong> {{ total_storage_gb | round(2) }} GB</p>
                <p><strong>Stockage utilisé :</strong> {{ used_storage_gb | round(2) }} GB</p>
                {% if used_storage_percent >=81 %}
                    <p class="red"><strong>Utilisation stockage  :</strong> {{ used_storage_percent | round(1) }} %</p>
                {% elif used_storage_percent is gt(50) and used_storage_percent is lt(80) %}
                    <p class="orange"><strong>Utilisation stockage  :</strong> {{ used_storage_percent | round(1) }} %</p>
                {% else %}
                    <p class="green"><strong>Utilisation stockage :</strong> {{ used_storage_percent | round(1) }} %</p>
                {% endif %}
            </div>
        </section>

        <!-- Processus -->
        <section id="process">
            <h2>Processus</h2>
            <div class="card">
                <h3>Top 3 par RAM</h3>
                <ol>
                    {% for p in top3_ram %}
                    <li>{{ p.name }} (PID {{ p.pid }}) — RAM {{ p.memory_percent | round(1) }} %</li>
                    {% endfor %}
                </ol>
                <h3>Top 3 par CPU</h3>
                <ol>
                    {% for p in top3_cpu %}
                    <li>{{ p.name }} (PID {{ p.pid }}) — CPU {{ p.cpu_percent | round(1) }} %</li>
                    {% endfor %}
                </ol>
            </div>
        </section>

        <!-- Fichiers -->
        <section id="files">
            <h2>Analyse de fichiers approfondie</h2>

            <div class="card">
                <p><strong>Dossier analysé :</strong> {{ analysed_directory }}</p>
            </div>

            <div class="card">
                <h3>Répartition par extension</h3>
                <table class>
                    <thead>
                        <tr>
                            <th>Extension</th>
                            <th>Nombre</th>
                            <th>Taille totale (MB)</th>
                            <th>Pourcentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ext, info in file_info.items() %}
                        <tr>
                            <td>{{ ext }}</td>
                            <td>{{ info.count }}</td>
                            <td>{{ (info.size / (1024*1024)) | round(2) }}</td>
                            <td>{{ file_percentages[ext] | round(1) }} %</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h3>Top 5 fichiers les plus volumineux</h3>
                <ol>
                    {% for filepath, size in largest_files %}
                    <li>{{ filepath }} — {{ (size / (1024*1024)) | round(2) }} MB</li>
                    {% endfor %}
                </ol>
            </div>

            <div class="card">
                <h3>Graphique des pourcentages par extension</h3>
                <canvas id="pie_chart"></canvas>
            </div>
        </section>
    </main>

    <footer>
        <p>Mis à jour : {{ date_test }}</p>
        <p>Version 2.0</p>
    </footer>

    <!-- Chart.js -->
    <script>
        const labels = {{ file_info.keys() | list | safe }};
        const dataValues = {{ file_percentages.values() | list | safe }};
        const colors = [
            "#E3E3E3","#456882","#234C6A","#1B3C53",
            "#6A8CA3","#A3BFD9","#82A6C9","#345678",
            "#789ABC","#123456","#9AA5B1","#4C566A"
        ];

        const ctx = document.getElementById('pie_chart');
        new Chart(ctx, {
            type: "pie",
            data: {
                labels: labels,
                datasets: [{
                    data: dataValues,
                    backgroundColor: colors.slice(0, labels.length)
                }]
            },
            options: {
                responsive : false,
                plugins: {
                    legend: { display: true, position: 'right' },
                    
                }
            }
        });
    </script>
</body>
</html>